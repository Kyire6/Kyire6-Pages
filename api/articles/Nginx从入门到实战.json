{"title":"Nginx 从入门到实战","slug":"Nginx从入门到实战","date":"2022-04-23T17:27:18.000Z","updated":"2022-04-23T17:27:18.000Z","comments":true,"path":"api/articles/Nginx从入门到实战.json","excerpt":null,"covers":["https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220424022100.png"],"content":"<h2 id=\"Nginx-的安装\"><a href=\"#Nginx-的安装\" class=\"headerlink\" title=\"Nginx 的安装\"></a>Nginx 的安装</h2><p>本文 Linux 环境基于 <code>centos7</code></p>\n<h3 id=\"版本区别\"><a href=\"#版本区别\" class=\"headerlink\" title=\"版本区别\"></a>版本区别</h3><p>常用版本分为四大阵营</p>\n<ul>\n<li>Nginx 开源版 <a href=\"http://nginx.org/\">http://nginx.org/</a></li>\n<li>Nginx plus 商业版 <a href=\"https://www.nginx.com/\">https://www.nginx.com</a></li>\n<li>openresty <a href=\"http://openresty.org/cn/\">http://openresty.org/cn/</a></li>\n<li>Tengine <a href=\"http://tengine.taobao.org/\">http://tengine.taobao.org/</a></li>\n</ul>\n<h3 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h3><p>这里下载的是 <code>nginx-1.21.6.tar.gz</code> ，解压后编译安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解压</span></span><br><span class=\"line\">tar zxvf nginx-1.21.6.tar.gz -C ./</span><br><span class=\"line\"><span class=\"built_in\">cd</span> nginx-1.21.6</span><br><span class=\"line\"><span class=\"comment\"># 执行配置脚本</span></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx</span><br><span class=\"line\"><span class=\"comment\"># 安装</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如果出现警告或报错\"><a href=\"#如果出现警告或报错\" class=\"headerlink\" title=\"如果出现警告或报错\"></a>如果出现警告或报错</h3><p>一般是缺少依赖的问题</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装gcc</span></span><br><span class=\"line\">yum install -y gcc</span><br><span class=\"line\"><span class=\"comment\"># 安装perl库</span></span><br><span class=\"line\">yum install -y pcre pcre-devel</span><br><span class=\"line\"><span class=\"comment\"># 安装zlib库</span></span><br><span class=\"line\">yum install -y zlib zlib-devel</span><br><span class=\"line\"><span class=\"comment\"># 重新执行安装</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装成系统服务\"><a href=\"#安装成系统服务\" class=\"headerlink\" title=\"安装成系统服务\"></a>安装成系统服务</h3><ol>\n<li>创建服务脚本</li>\n</ol>\n<p><code>vi /usr/lib/systemd/system/nginx.service</code></p>\n<ol start=\"2\">\n<li>服务脚本内容</li>\n</ol>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\"><span class=\"keyword\">Description</span>=nginx - web server</span><br><span class=\"line\">After=network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>logs/nginx.pid</span><br><span class=\"line\">ExecStartPre=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin<span class=\"regexp\">/nginx -t -c /u</span>sr<span class=\"regexp\">/local/</span>nginx<span class=\"regexp\">/conf/</span>nginx.conf</span><br><span class=\"line\">ExecStart=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin<span class=\"regexp\">/nginx -c /u</span>sr<span class=\"regexp\">/local/</span>nginx<span class=\"regexp\">/conf/</span>nginx.conf</span><br><span class=\"line\">ExecReload=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin/nginx -s reload</span><br><span class=\"line\">ExecStop=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin/nginx -s stop</span><br><span class=\"line\">ExecQuit=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin/nginx -s quit</span><br><span class=\"line\">PrivateTmp=<span class=\"keyword\">true</span></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>重新加载系统服务</li>\n</ol>\n<p><code>systemctl daemon-reload</code></p>\n<ol start=\"4\">\n<li>启动服务</li>\n</ol>\n<p><code>systemctl start nginx.service</code></p>\n<ol start=\"5\">\n<li>开机自启</li>\n</ol>\n<p><code>systemctl enable nginx.service</code></p>\n<h2 id=\"Nginx-基础使用\"><a href=\"#Nginx-基础使用\" class=\"headerlink\" title=\"Nginx 基础使用\"></a>Nginx 基础使用</h2><h3 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h3><p>进入<code>Nginx</code>的主目录可以看到这些文件夹</p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">client_body_temp conf fastcgi_temp html logs proxy_temp <span class=\"keyword\">sbin </span><span class=\"keyword\">scgi_temp </span>uwsgi_temp</span><br></pre></td></tr></table></figure>\n\n<p>其中这几个文件夹在刚安装时是没有的， 主要用来存放运行过程中的临时文件</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">client_body_temp fastcgi_temp proxy_temp scgi_temp</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>conf：用来存放配置文件</li>\n<li>html：用来存放静态文件的默认目录 html、css 等</li>\n<li>sbin：nginx 的主程序</li>\n<li>logs：nginx 运行日志</li>\n</ul>\n<h3 id=\"基本运行原理\"><a href=\"#基本运行原理\" class=\"headerlink\" title=\"基本运行原理\"></a>基本运行原理</h3><p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220424022100.png\" alt=\"image-20220424022053512\"></p>\n<h2 id=\"Nginx-配置\"><a href=\"#Nginx-配置\" class=\"headerlink\" title=\"Nginx 配置\"></a>Nginx 配置</h2><h3 id=\"最小配置\"><a href=\"#最小配置\" class=\"headerlink\" title=\"最小配置\"></a>最小配置</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  默认为1，表示开启一个业务进程</span></span><br><span class=\"line\">worker_processes  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">\t<span class=\"comment\"># 单个业务进程可接受连接数</span></span><br><span class=\"line\">    worker_connections  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">\t<span class=\"comment\"># 引入http mime类型</span></span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    <span class=\"comment\"># 如果mime类型没匹配上，默认使用二进制流的方式传输。</span></span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">\t使用linux的 sendfile(socket, file, len) 高效网络传输，也就是数据<span class=\"number\">0</span>拷贝。</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_timeout  <span class=\"number\">65</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># 虚拟主机 vhost</span></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">    \t<span class=\"comment\"># 监听端口号</span></span><br><span class=\"line\">        listen       <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"comment\"># 域名、主机名</span></span><br><span class=\"line\">        server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\"># 匹配路径</span></span><br><span class=\"line\">        <span class=\"keyword\">location</span> <span class=\"title\">/ &#123;</span></span><br><span class=\"line\"><span class=\"title\">            root</span>   html; <span class=\"comment\"># 文件根目录</span></span><br><span class=\"line\">            index  index.html index.htm; <span class=\"comment\"># 默认页名称</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\"># 报错编码对应页面</span></span><br><span class=\"line\">        error_page   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /<span class=\"number\">50</span>x.html;</span><br><span class=\"line\">        <span class=\"keyword\">location</span> <span class=\"title\">= /50x</span>.html &#123;</span><br><span class=\"line\">            root   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"虚拟主机\"><a href=\"#虚拟主机\" class=\"headerlink\" title=\"虚拟主机\"></a>虚拟主机</h3><p>原本一台服务器只能对应一个站点，通过虚拟主机技术可以虚拟化成多个站点同时对外提供服务</p>\n<p><strong>server_name 匹配规则</strong></p>\n<p>我们需要注意的是 <code>server_name</code> 匹配分先后顺序，写在前面的匹配上就不会继续往下匹配了。</p>\n<ul>\n<li>完整匹配</li>\n</ul>\n<p>可以在同一个 <code>server_name</code> 中配置多个域名</p>\n<figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server_name abc.com abc123.com<span class=\"comment\">;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>通配符匹配</li>\n</ul>\n<p>可以通过 <code>*</code> 通配符来模糊匹配多个域名，可以在开始和结尾使用</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">server_name</span> <span class=\"regexp\">*.abc.com</span> <span class=\"regexp\">abc.*</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>正则匹配</li>\n</ul>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">server_name</span> ~^[<span class=\"number\">0</span>-<span class=\"number\">9</span>]+\\.abc\\.com$</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"反向代理\"><a href=\"#反向代理\" class=\"headerlink\" title=\"反向代理\"></a>反向代理</h3><p>通过关键字 <code>proxy_pass</code> 关键字来指定一个服务器地址（ip/域名）</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> http://www.baidu.com/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h4><ul>\n<li>基于反向代理的负载均衡配置</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> app &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.102:80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.103:80</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> http://app;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"负载均衡策略\"><a href=\"#负载均衡策略\" class=\"headerlink\" title=\"负载均衡策略\"></a>负载均衡策略</h4><ul>\n<li><strong>轮询</strong></li>\n</ul>\n<p>默认情况下使用轮询方式，逐一转发，这种方式适用于无状态请求</p>\n<ul>\n<li><strong>权重（weight）</strong><ul>\n<li>down：表示当前的主机暂时不参与负载</li>\n<li>weight：默认为 1，weight 越大，负载的权重就越大</li>\n<li>backup： 其它所有的非 backup 机器 down 或者忙的时候，请求 backup 机器</li>\n</ul>\n</li>\n</ul>\n<p>指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> app &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.102:80</span> weight=<span class=\"number\">10</span> down;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.103:80</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:8060</span> weight=<span class=\"number\">1</span> backup;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>ip_hash</strong></li>\n</ul>\n<p>根据客户端的 ip 地址转发同一台服务器，可以保持回话</p>\n<ul>\n<li><strong>least_conn</strong></li>\n</ul>\n<p>最少连接数访问</p>\n<ul>\n<li><strong>url_hash</strong></li>\n</ul>\n<p>根据用户访问的 url 定向转发请求</p>\n<ul>\n<li><strong>fair</strong></li>\n</ul>\n<p>根据后端服务器响应时间转发请求</p>\n<h3 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h3><ul>\n<li>配置后端服务的反向代理</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>配置前端静态资源</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /css &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> /images &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> /js &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 正则匹配</span></span><br><span class=\"line\"><span class=\"section\">location</span> ~*/(css|img|js) &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"location-配置规则\"><a href=\"#location-配置规则\" class=\"headerlink\" title=\"location 配置规则\"></a>location 配置规则</h3><h4 id=\"location-前缀\"><a href=\"#location-前缀\" class=\"headerlink\" title=\"location 前缀\"></a>location 前缀</h4><ul>\n<li><p>/ 通用匹配，任何请求都会匹配到</p>\n</li>\n<li><p>= 精准匹配，不是以指定模式开头</p>\n</li>\n<li><p>~ 正则匹配，区分大小写</p>\n</li>\n<li><p>~* 正则匹配，不区分大小写</p>\n</li>\n<li><p>^~ 非正则匹配，匹配以指定模式开头的 location</p>\n</li>\n</ul>\n<h4 id=\"location-匹配规则\"><a href=\"#location-匹配规则\" class=\"headerlink\" title=\"location 匹配规则\"></a>location 匹配规则</h4><ul>\n<li>多个正则 <code>location</code> 直接按书写顺序匹配，匹配成功后就不会往下匹配</li>\n<li>普通（非正则）<code>location</code> 会一直往下，直到找到匹配度最高的（最大前缀匹配）</li>\n<li>当普通 <code>location</code> 与正则 <code>location</code> 同时存在，如果正则匹配成功,则不会再执行普通匹配</li>\n<li>所有类型 <code>location</code> 存在时，<code>=匹配</code> &gt; <code>^~匹配</code> &gt; <code>正则匹配</code> &gt; <code>普通（最大前缀匹配）</code></li>\n</ul>\n<h4 id=\"alias-与-root\"><a href=\"#alias-与-root\" class=\"headerlink\" title=\"alias 与 root\"></a>alias 与 root</h4><p><code>root</code> 用来设置根目录，而 <code>alias</code> 在接受请求的时候在路径上不会加上 <code>location</code></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /css &#123;</span><br><span class=\"line\">    <span class=\"attribute\">alias</span> /usr/local/nginx/static/css;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>alias 指定的目录是准确的，即 location 匹配访问的 path 目录下的文件直接是在 alias 目录下查找的；</li>\n<li>root 指定 的目录是 location 匹配访问的 path 目录的上一级目录,这个 path 目录一定要是真实存在 root 指定目录下的；</li>\n<li>使用 alias 标签的目录块中不能使用 rewrite 的 break（具体原因不明）；另外，alias 指定的目录后面必须要加上”/“符 号！！</li>\n<li>alias 虚拟目录配置中，location 匹配的 path 目录如果后面不带”/“，那么访问的 url 地址中这个 path 目录后 面加不加”/“不影响访问，访问时它会自动加上”/“； 但是如果 location 匹配的 path 目录后面加上”/“，那么访问的 url 地 址中这个 path 目录必须要加上”/“，访问时它不会自动加上”/“。如果不加上”/“，访问就会失败！</li>\n<li>root 目录配置中，location 匹配的 path 目录后面带不带”/“，都不会影响访问。</li>\n</ul>\n<h3 id=\"URLRewrite\"><a href=\"#URLRewrite\" class=\"headerlink\" title=\"URLRewrite\"></a>URLRewrite</h3><p>rewirte 语法格式及参数语法：</p>\n<p><code>rewrite</code> 是实现 URL 重写的关键指令，根据 <code>regex (正则表达式)</code> 部分内容，重定向到 <code>replacement</code>，结尾是 <code>flag</code> 标记。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rewrite   <span class=\"tag\">&lt;<span class=\"name\">regex</span>&gt;</span>   <span class=\"tag\">&lt;<span class=\"name\">replacement</span>&gt;</span>   [flag];</span><br><span class=\"line\">关键字     正则       替代内容         flag标记</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>关键字</strong>：其中关键字 <code>rewrite</code> 不能改变</li>\n<li><strong>正则</strong>：正则表达式语句进行规则匹配</li>\n<li><strong>替代内容</strong>：将正则匹配的内容替换成 <code>replacement</code></li>\n<li><strong>flag 标记</strong>：<code>rewrite</code> 支持的 <code>flag</code> 标记</li>\n</ul>\n<blockquote>\n<p>rewrite 参数的标签段位置：server、location、if</p>\n</blockquote>\n<p><strong>flag 标记说明：</strong></p>\n<ul>\n<li>last：本条规则匹配完成后，继续向下匹配新的 location URI 规则</li>\n<li>break：本条规则匹配完成即终止，不再匹配后面的任何规则</li>\n<li>redirect：返回 302 临时重定向，浏览器地址会显示跳转后的 URL 地址</li>\n<li>permanent：返回 301 永久重定向，浏览器地址栏会显示跳转后的 URL 地址</li>\n</ul>\n<h3 id=\"防盗链配置\"><a href=\"#防盗链配置\" class=\"headerlink\" title=\"防盗链配置\"></a>防盗链配置</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">valid_referers</span> <span class=\"literal\">none</span> | <span class=\"literal\">blocked</span> | server_names | strings ....;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>none：检测 <code>Referer</code> 头域不存在的情况</li>\n<li>blocked：检测 <code>Referer</code> 头域的值被防火墙或者代理服务器删除或伪装的情况。这种情况该头域的值不以 <code>http://</code> 或 <code>https://</code> 开头</li>\n<li>server_names：设置一个或多个 <code>URL</code> ，检测 <code>Referer</code> 头域的值是否是这些 <code>URL</code> 中的某一个。</li>\n</ul>\n<p><strong>使用 curl 测试</strong></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -I http:<span class=\"regexp\">//</span><span class=\"number\">192.168</span>.<span class=\"number\">44.101</span><span class=\"regexp\">/img/</span>logo.png</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -I 表示只显示响应的头信息</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>带引用</strong></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -e <span class=\"string\">&quot;http://baidu.com&quot;</span> -I http:<span class=\"regexp\">//</span><span class=\"number\">192.168</span>.<span class=\"number\">44.101</span><span class=\"regexp\">/img/</span>logo.png</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"高可用配置\"><a href=\"#高可用配置\" class=\"headerlink\" title=\"高可用配置\"></a>高可用配置</h3><h4 id=\"安装-Keepalived\"><a href=\"#安装-Keepalived\" class=\"headerlink\" title=\"安装 Keepalived\"></a>安装 Keepalived</h4><ul>\n<li>编译安装</li>\n</ul>\n<p>下载地址：<a href=\"https://www.keepalived.org/download.html#\">https://www.keepalived.org/download.html#</a></p>\n<figure class=\"highlight erlang-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 解压之后通过命令安装</span><br><span class=\"line\">./configure</span><br><span class=\"line\"></span><br><span class=\"line\"># 如遇报错提示</span><br><span class=\"line\">configure: error:</span><br><span class=\"line\">!!! OpenSSL is not properly installed on your system. !!!</span><br><span class=\"line\">!!! Can not include OpenSSL headers files. !!!</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装依赖</span><br><span class=\"line\">yum install openssl-devel</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>yum 安装</li>\n</ul>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum <span class=\"keyword\">install</span> keepalived</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h4><p>使用 <code>yum</code> 安装后的配置文件在 <code>/etc/keepalived/keepalived.conf</code></p>\n<p><strong>最小配置</strong></p>\n<p>主机：</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! Configuration File <span class=\"keyword\">for</span> keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">\trouter_id lb101</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_instance vansys &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    <span class=\"keyword\">interface</span> <span class=\"symbol\">ens33</span></span><br><span class=\"line\">    <span class=\"symbol\">virtual_router_id</span> <span class=\"symbol\">51</span></span><br><span class=\"line\">    <span class=\"symbol\">priority</span> <span class=\"symbol\">100</span></span><br><span class=\"line\">    <span class=\"symbol\">advert_int</span> <span class=\"symbol\">1</span></span><br><span class=\"line\">    <span class=\"symbol\">authentication</span> &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">    \t<span class=\"number\">192.168</span><span class=\"number\">.44</span><span class=\"number\">.200</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>从机：</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! Configuration File <span class=\"keyword\">for</span> keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">\trouter_id lb100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_instance vansys &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    <span class=\"keyword\">interface</span> <span class=\"symbol\">ens33</span></span><br><span class=\"line\">    <span class=\"symbol\">virtual_router_id</span> <span class=\"symbol\">51</span></span><br><span class=\"line\">    <span class=\"symbol\">priority</span> <span class=\"symbol\">100</span></span><br><span class=\"line\">    <span class=\"symbol\">advert_int</span> <span class=\"symbol\">1</span></span><br><span class=\"line\">    <span class=\"symbol\">authentication</span> &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">    \t<span class=\"number\">192.168</span><span class=\"number\">.44</span><span class=\"number\">.200</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>启动服务</strong></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"literal\">start</span> keepalived</span><br></pre></td></tr></table></figure>\n","more":"<h2 id=\"Nginx-的安装\"><a href=\"#Nginx-的安装\" class=\"headerlink\" title=\"Nginx 的安装\"></a>Nginx 的安装</h2><p>本文 Linux 环境基于 <code>centos7</code></p>\n<h3 id=\"版本区别\"><a href=\"#版本区别\" class=\"headerlink\" title=\"版本区别\"></a>版本区别</h3><p>常用版本分为四大阵营</p>\n<ul>\n<li>Nginx 开源版 <a href=\"http://nginx.org/\">http://nginx.org/</a></li>\n<li>Nginx plus 商业版 <a href=\"https://www.nginx.com/\">https://www.nginx.com</a></li>\n<li>openresty <a href=\"http://openresty.org/cn/\">http://openresty.org/cn/</a></li>\n<li>Tengine <a href=\"http://tengine.taobao.org/\">http://tengine.taobao.org/</a></li>\n</ul>\n<h3 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h3><p>这里下载的是 <code>nginx-1.21.6.tar.gz</code> ，解压后编译安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解压</span></span><br><span class=\"line\">tar zxvf nginx-1.21.6.tar.gz -C ./</span><br><span class=\"line\"><span class=\"built_in\">cd</span> nginx-1.21.6</span><br><span class=\"line\"><span class=\"comment\"># 执行配置脚本</span></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx</span><br><span class=\"line\"><span class=\"comment\"># 安装</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"如果出现警告或报错\"><a href=\"#如果出现警告或报错\" class=\"headerlink\" title=\"如果出现警告或报错\"></a>如果出现警告或报错</h3><p>一般是缺少依赖的问题</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装gcc</span></span><br><span class=\"line\">yum install -y gcc</span><br><span class=\"line\"><span class=\"comment\"># 安装perl库</span></span><br><span class=\"line\">yum install -y pcre pcre-devel</span><br><span class=\"line\"><span class=\"comment\"># 安装zlib库</span></span><br><span class=\"line\">yum install -y zlib zlib-devel</span><br><span class=\"line\"><span class=\"comment\"># 重新执行安装</span></span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装成系统服务\"><a href=\"#安装成系统服务\" class=\"headerlink\" title=\"安装成系统服务\"></a>安装成系统服务</h3><ol>\n<li>创建服务脚本</li>\n</ol>\n<p><code>vi /usr/lib/systemd/system/nginx.service</code></p>\n<ol start=\"2\">\n<li>服务脚本内容</li>\n</ol>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\"><span class=\"keyword\">Description</span>=nginx - web server</span><br><span class=\"line\">After=network.target remote-fs.target nss-lookup.target</span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>logs/nginx.pid</span><br><span class=\"line\">ExecStartPre=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin<span class=\"regexp\">/nginx -t -c /u</span>sr<span class=\"regexp\">/local/</span>nginx<span class=\"regexp\">/conf/</span>nginx.conf</span><br><span class=\"line\">ExecStart=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin<span class=\"regexp\">/nginx -c /u</span>sr<span class=\"regexp\">/local/</span>nginx<span class=\"regexp\">/conf/</span>nginx.conf</span><br><span class=\"line\">ExecReload=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin/nginx -s reload</span><br><span class=\"line\">ExecStop=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin/nginx -s stop</span><br><span class=\"line\">ExecQuit=<span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>sbin/nginx -s quit</span><br><span class=\"line\">PrivateTmp=<span class=\"keyword\">true</span></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>重新加载系统服务</li>\n</ol>\n<p><code>systemctl daemon-reload</code></p>\n<ol start=\"4\">\n<li>启动服务</li>\n</ol>\n<p><code>systemctl start nginx.service</code></p>\n<ol start=\"5\">\n<li>开机自启</li>\n</ol>\n<p><code>systemctl enable nginx.service</code></p>\n<h2 id=\"Nginx-基础使用\"><a href=\"#Nginx-基础使用\" class=\"headerlink\" title=\"Nginx 基础使用\"></a>Nginx 基础使用</h2><h3 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h3><p>进入<code>Nginx</code>的主目录可以看到这些文件夹</p>\n<figure class=\"highlight mipsasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">client_body_temp conf fastcgi_temp html logs proxy_temp <span class=\"keyword\">sbin </span><span class=\"keyword\">scgi_temp </span>uwsgi_temp</span><br></pre></td></tr></table></figure>\n\n<p>其中这几个文件夹在刚安装时是没有的， 主要用来存放运行过程中的临时文件</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">client_body_temp fastcgi_temp proxy_temp scgi_temp</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>conf：用来存放配置文件</li>\n<li>html：用来存放静态文件的默认目录 html、css 等</li>\n<li>sbin：nginx 的主程序</li>\n<li>logs：nginx 运行日志</li>\n</ul>\n<h3 id=\"基本运行原理\"><a href=\"#基本运行原理\" class=\"headerlink\" title=\"基本运行原理\"></a>基本运行原理</h3><p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220424022100.png\" alt=\"image-20220424022053512\"></p>\n<h2 id=\"Nginx-配置\"><a href=\"#Nginx-配置\" class=\"headerlink\" title=\"Nginx 配置\"></a>Nginx 配置</h2><h3 id=\"最小配置\"><a href=\"#最小配置\" class=\"headerlink\" title=\"最小配置\"></a>最小配置</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  默认为1，表示开启一个业务进程</span></span><br><span class=\"line\">worker_processes  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">\t<span class=\"comment\"># 单个业务进程可接受连接数</span></span><br><span class=\"line\">    worker_connections  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">\t<span class=\"comment\"># 引入http mime类型</span></span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    <span class=\"comment\"># 如果mime类型没匹配上，默认使用二进制流的方式传输。</span></span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">\t使用linux的 sendfile(socket, file, len) 高效网络传输，也就是数据<span class=\"number\">0</span>拷贝。</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_timeout  <span class=\"number\">65</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># 虚拟主机 vhost</span></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">    \t<span class=\"comment\"># 监听端口号</span></span><br><span class=\"line\">        listen       <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"comment\"># 域名、主机名</span></span><br><span class=\"line\">        server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\"># 匹配路径</span></span><br><span class=\"line\">        <span class=\"keyword\">location</span> <span class=\"title\">/ &#123;</span></span><br><span class=\"line\"><span class=\"title\">            root</span>   html; <span class=\"comment\"># 文件根目录</span></span><br><span class=\"line\">            index  index.html index.htm; <span class=\"comment\"># 默认页名称</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\"># 报错编码对应页面</span></span><br><span class=\"line\">        error_page   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /<span class=\"number\">50</span>x.html;</span><br><span class=\"line\">        <span class=\"keyword\">location</span> <span class=\"title\">= /50x</span>.html &#123;</span><br><span class=\"line\">            root   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"虚拟主机\"><a href=\"#虚拟主机\" class=\"headerlink\" title=\"虚拟主机\"></a>虚拟主机</h3><p>原本一台服务器只能对应一个站点，通过虚拟主机技术可以虚拟化成多个站点同时对外提供服务</p>\n<p><strong>server_name 匹配规则</strong></p>\n<p>我们需要注意的是 <code>server_name</code> 匹配分先后顺序，写在前面的匹配上就不会继续往下匹配了。</p>\n<ul>\n<li>完整匹配</li>\n</ul>\n<p>可以在同一个 <code>server_name</code> 中配置多个域名</p>\n<figure class=\"highlight abnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server_name abc.com abc123.com<span class=\"comment\">;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>通配符匹配</li>\n</ul>\n<p>可以通过 <code>*</code> 通配符来模糊匹配多个域名，可以在开始和结尾使用</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">server_name</span> <span class=\"regexp\">*.abc.com</span> <span class=\"regexp\">abc.*</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>正则匹配</li>\n</ul>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">server_name</span> ~^[<span class=\"number\">0</span>-<span class=\"number\">9</span>]+\\.abc\\.com$</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"反向代理\"><a href=\"#反向代理\" class=\"headerlink\" title=\"反向代理\"></a>反向代理</h3><p>通过关键字 <code>proxy_pass</code> 关键字来指定一个服务器地址（ip/域名）</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> http://www.baidu.com/;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h4><ul>\n<li>基于反向代理的负载均衡配置</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> app &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.102:80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.103:80</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> http://app;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"负载均衡策略\"><a href=\"#负载均衡策略\" class=\"headerlink\" title=\"负载均衡策略\"></a>负载均衡策略</h4><ul>\n<li><strong>轮询</strong></li>\n</ul>\n<p>默认情况下使用轮询方式，逐一转发，这种方式适用于无状态请求</p>\n<ul>\n<li><strong>权重（weight）</strong><ul>\n<li>down：表示当前的主机暂时不参与负载</li>\n<li>weight：默认为 1，weight 越大，负载的权重就越大</li>\n<li>backup： 其它所有的非 backup 机器 down 或者忙的时候，请求 backup 机器</li>\n</ul>\n</li>\n</ul>\n<p>指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> app &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.102:80</span> weight=<span class=\"number\">10</span> down;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">192.168.88.103:80</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">127.0.0.1:8060</span> weight=<span class=\"number\">1</span> backup;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>ip_hash</strong></li>\n</ul>\n<p>根据客户端的 ip 地址转发同一台服务器，可以保持回话</p>\n<ul>\n<li><strong>least_conn</strong></li>\n</ul>\n<p>最少连接数访问</p>\n<ul>\n<li><strong>url_hash</strong></li>\n</ul>\n<p>根据用户访问的 url 定向转发请求</p>\n<ul>\n<li><strong>fair</strong></li>\n</ul>\n<p>根据后端服务器响应时间转发请求</p>\n<h3 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h3><ul>\n<li>配置后端服务的反向代理</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_pass</span> http://127.0.0.1:8080;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>配置前端静态资源</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /css &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> /images &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> /js &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 正则匹配</span></span><br><span class=\"line\"><span class=\"section\">location</span> ~*/(css|img|js) &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local/nginx/static;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"location-配置规则\"><a href=\"#location-配置规则\" class=\"headerlink\" title=\"location 配置规则\"></a>location 配置规则</h3><h4 id=\"location-前缀\"><a href=\"#location-前缀\" class=\"headerlink\" title=\"location 前缀\"></a>location 前缀</h4><ul>\n<li><p>/ 通用匹配，任何请求都会匹配到</p>\n</li>\n<li><p>= 精准匹配，不是以指定模式开头</p>\n</li>\n<li><p>~ 正则匹配，区分大小写</p>\n</li>\n<li><p>~* 正则匹配，不区分大小写</p>\n</li>\n<li><p>^~ 非正则匹配，匹配以指定模式开头的 location</p>\n</li>\n</ul>\n<h4 id=\"location-匹配规则\"><a href=\"#location-匹配规则\" class=\"headerlink\" title=\"location 匹配规则\"></a>location 匹配规则</h4><ul>\n<li>多个正则 <code>location</code> 直接按书写顺序匹配，匹配成功后就不会往下匹配</li>\n<li>普通（非正则）<code>location</code> 会一直往下，直到找到匹配度最高的（最大前缀匹配）</li>\n<li>当普通 <code>location</code> 与正则 <code>location</code> 同时存在，如果正则匹配成功,则不会再执行普通匹配</li>\n<li>所有类型 <code>location</code> 存在时，<code>=匹配</code> &gt; <code>^~匹配</code> &gt; <code>正则匹配</code> &gt; <code>普通（最大前缀匹配）</code></li>\n</ul>\n<h4 id=\"alias-与-root\"><a href=\"#alias-与-root\" class=\"headerlink\" title=\"alias 与 root\"></a>alias 与 root</h4><p><code>root</code> 用来设置根目录，而 <code>alias</code> 在接受请求的时候在路径上不会加上 <code>location</code></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /css &#123;</span><br><span class=\"line\">    <span class=\"attribute\">alias</span> /usr/local/nginx/static/css;</span><br><span class=\"line\">    <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>alias 指定的目录是准确的，即 location 匹配访问的 path 目录下的文件直接是在 alias 目录下查找的；</li>\n<li>root 指定 的目录是 location 匹配访问的 path 目录的上一级目录,这个 path 目录一定要是真实存在 root 指定目录下的；</li>\n<li>使用 alias 标签的目录块中不能使用 rewrite 的 break（具体原因不明）；另外，alias 指定的目录后面必须要加上”/“符 号！！</li>\n<li>alias 虚拟目录配置中，location 匹配的 path 目录如果后面不带”/“，那么访问的 url 地址中这个 path 目录后 面加不加”/“不影响访问，访问时它会自动加上”/“； 但是如果 location 匹配的 path 目录后面加上”/“，那么访问的 url 地 址中这个 path 目录必须要加上”/“，访问时它不会自动加上”/“。如果不加上”/“，访问就会失败！</li>\n<li>root 目录配置中，location 匹配的 path 目录后面带不带”/“，都不会影响访问。</li>\n</ul>\n<h3 id=\"URLRewrite\"><a href=\"#URLRewrite\" class=\"headerlink\" title=\"URLRewrite\"></a>URLRewrite</h3><p>rewirte 语法格式及参数语法：</p>\n<p><code>rewrite</code> 是实现 URL 重写的关键指令，根据 <code>regex (正则表达式)</code> 部分内容，重定向到 <code>replacement</code>，结尾是 <code>flag</code> 标记。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rewrite   <span class=\"tag\">&lt;<span class=\"name\">regex</span>&gt;</span>   <span class=\"tag\">&lt;<span class=\"name\">replacement</span>&gt;</span>   [flag];</span><br><span class=\"line\">关键字     正则       替代内容         flag标记</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>关键字</strong>：其中关键字 <code>rewrite</code> 不能改变</li>\n<li><strong>正则</strong>：正则表达式语句进行规则匹配</li>\n<li><strong>替代内容</strong>：将正则匹配的内容替换成 <code>replacement</code></li>\n<li><strong>flag 标记</strong>：<code>rewrite</code> 支持的 <code>flag</code> 标记</li>\n</ul>\n<blockquote>\n<p>rewrite 参数的标签段位置：server、location、if</p>\n</blockquote>\n<p><strong>flag 标记说明：</strong></p>\n<ul>\n<li>last：本条规则匹配完成后，继续向下匹配新的 location URI 规则</li>\n<li>break：本条规则匹配完成即终止，不再匹配后面的任何规则</li>\n<li>redirect：返回 302 临时重定向，浏览器地址会显示跳转后的 URL 地址</li>\n<li>permanent：返回 301 永久重定向，浏览器地址栏会显示跳转后的 URL 地址</li>\n</ul>\n<h3 id=\"防盗链配置\"><a href=\"#防盗链配置\" class=\"headerlink\" title=\"防盗链配置\"></a>防盗链配置</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">valid_referers</span> <span class=\"literal\">none</span> | <span class=\"literal\">blocked</span> | server_names | strings ....;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>none：检测 <code>Referer</code> 头域不存在的情况</li>\n<li>blocked：检测 <code>Referer</code> 头域的值被防火墙或者代理服务器删除或伪装的情况。这种情况该头域的值不以 <code>http://</code> 或 <code>https://</code> 开头</li>\n<li>server_names：设置一个或多个 <code>URL</code> ，检测 <code>Referer</code> 头域的值是否是这些 <code>URL</code> 中的某一个。</li>\n</ul>\n<p><strong>使用 curl 测试</strong></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -I http:<span class=\"regexp\">//</span><span class=\"number\">192.168</span>.<span class=\"number\">44.101</span><span class=\"regexp\">/img/</span>logo.png</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -I 表示只显示响应的头信息</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>带引用</strong></p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -e <span class=\"string\">&quot;http://baidu.com&quot;</span> -I http:<span class=\"regexp\">//</span><span class=\"number\">192.168</span>.<span class=\"number\">44.101</span><span class=\"regexp\">/img/</span>logo.png</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"高可用配置\"><a href=\"#高可用配置\" class=\"headerlink\" title=\"高可用配置\"></a>高可用配置</h3><h4 id=\"安装-Keepalived\"><a href=\"#安装-Keepalived\" class=\"headerlink\" title=\"安装 Keepalived\"></a>安装 Keepalived</h4><ul>\n<li>编译安装</li>\n</ul>\n<p>下载地址：<a href=\"https://www.keepalived.org/download.html#\">https://www.keepalived.org/download.html#</a></p>\n<figure class=\"highlight erlang-repl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 解压之后通过命令安装</span><br><span class=\"line\">./configure</span><br><span class=\"line\"></span><br><span class=\"line\"># 如遇报错提示</span><br><span class=\"line\">configure: error:</span><br><span class=\"line\">!!! OpenSSL is not properly installed on your system. !!!</span><br><span class=\"line\">!!! Can not include OpenSSL headers files. !!!</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装依赖</span><br><span class=\"line\">yum install openssl-devel</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>yum 安装</li>\n</ul>\n<figure class=\"highlight cmake\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum <span class=\"keyword\">install</span> keepalived</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h4><p>使用 <code>yum</code> 安装后的配置文件在 <code>/etc/keepalived/keepalived.conf</code></p>\n<p><strong>最小配置</strong></p>\n<p>主机：</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! Configuration File <span class=\"keyword\">for</span> keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">\trouter_id lb101</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_instance vansys &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    <span class=\"keyword\">interface</span> <span class=\"symbol\">ens33</span></span><br><span class=\"line\">    <span class=\"symbol\">virtual_router_id</span> <span class=\"symbol\">51</span></span><br><span class=\"line\">    <span class=\"symbol\">priority</span> <span class=\"symbol\">100</span></span><br><span class=\"line\">    <span class=\"symbol\">advert_int</span> <span class=\"symbol\">1</span></span><br><span class=\"line\">    <span class=\"symbol\">authentication</span> &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">    \t<span class=\"number\">192.168</span><span class=\"number\">.44</span><span class=\"number\">.200</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>从机：</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! Configuration File <span class=\"keyword\">for</span> keepalived</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">\trouter_id lb100</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_instance vansys &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    <span class=\"keyword\">interface</span> <span class=\"symbol\">ens33</span></span><br><span class=\"line\">    <span class=\"symbol\">virtual_router_id</span> <span class=\"symbol\">51</span></span><br><span class=\"line\">    <span class=\"symbol\">priority</span> <span class=\"symbol\">100</span></span><br><span class=\"line\">    <span class=\"symbol\">advert_int</span> <span class=\"symbol\">1</span></span><br><span class=\"line\">    <span class=\"symbol\">authentication</span> &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass <span class=\"number\">1111</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">    \t<span class=\"number\">192.168</span><span class=\"number\">.44</span><span class=\"number\">.200</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>启动服务</strong></p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"literal\">start</span> keepalived</span><br></pre></td></tr></table></figure>\n","categories":[{"name":"中间件","path":"api/categories/中间件.json"}],"tags":[{"name":"技巧","path":"api/tags/技巧.json"},{"name":"笔记","path":"api/tags/笔记.json"},{"name":"Nginx","path":"api/tags/Nginx.json"}]}