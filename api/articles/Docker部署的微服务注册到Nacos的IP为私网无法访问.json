{"title":"Docker 部署的微服务注册到 Nacos 的 IP 为私网无法访问","slug":"Docker部署的微服务注册到Nacos的IP为私网无法访问","date":"2022-08-11T01:44:29.000Z","updated":"2022-08-11T01:44:29.000Z","comments":true,"path":"api/articles/Docker部署的微服务注册到Nacos的IP为私网无法访问.json","excerpt":null,"covers":null,"content":"<h2 id=\"问题描述\"><a href=\"#问题描述\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h2><p>使用 docker 集群部署微服务时，注册到 nacos 上的 ip 会使用 docker 容器的虚拟内网 ip 作为注册地址，这会导致集群部署服务时，nacos 无法解析对应服务的 ip。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><blockquote>\n<p>参考：<a href=\"https://github.com/alibaba/nacos/issues/310\">注册服务获取 IP 的问题 · Issue #310 · alibaba/nacos (github.com)</a></p>\n</blockquote>\n<h3 id=\"方法一：\"><a href=\"#方法一：\" class=\"headerlink\" title=\"方法一：\"></a>方法一：</h3><p>docker compose 配置文件中设置网络模式为 host</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">network_mode:</span> <span class=\"string\">host</span></span><br></pre></td></tr></table></figure>\n\n<p>host 网络模式是直接使用宿主机的 IP 地址与外界进行通信</p>\n<h3 id=\"方法二：\"><a href=\"#方法二：\" class=\"headerlink\" title=\"方法二：\"></a>方法二：</h3><p>nacos 配置指定注册 ip/host</p>\n<p>application.yml 配置文件中添加如下配置即可：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">nacos:</span></span><br><span class=\"line\">      <span class=\"attr\">discovery:</span></span><br><span class=\"line\">        <span class=\"comment\"># 配置host，避免docker部署nacos注册服务ip为内网地址</span></span><br><span class=\"line\">        <span class=\"attr\">ip:</span> <span class=\"string\">xxx</span></span><br></pre></td></tr></table></figure>\n","more":"<h2 id=\"问题描述\"><a href=\"#问题描述\" class=\"headerlink\" title=\"问题描述\"></a>问题描述</h2><p>使用 docker 集群部署微服务时，注册到 nacos 上的 ip 会使用 docker 容器的虚拟内网 ip 作为注册地址，这会导致集群部署服务时，nacos 无法解析对应服务的 ip。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><blockquote>\n<p>参考：<a href=\"https://github.com/alibaba/nacos/issues/310\">注册服务获取 IP 的问题 · Issue #310 · alibaba/nacos (github.com)</a></p>\n</blockquote>\n<h3 id=\"方法一：\"><a href=\"#方法一：\" class=\"headerlink\" title=\"方法一：\"></a>方法一：</h3><p>docker compose 配置文件中设置网络模式为 host</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">network_mode:</span> <span class=\"string\">host</span></span><br></pre></td></tr></table></figure>\n\n<p>host 网络模式是直接使用宿主机的 IP 地址与外界进行通信</p>\n<h3 id=\"方法二：\"><a href=\"#方法二：\" class=\"headerlink\" title=\"方法二：\"></a>方法二：</h3><p>nacos 配置指定注册 ip/host</p>\n<p>application.yml 配置文件中添加如下配置即可：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">nacos:</span></span><br><span class=\"line\">      <span class=\"attr\">discovery:</span></span><br><span class=\"line\">        <span class=\"comment\"># 配置host，避免docker部署nacos注册服务ip为内网地址</span></span><br><span class=\"line\">        <span class=\"attr\">ip:</span> <span class=\"string\">xxx</span></span><br></pre></td></tr></table></figure>\n","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"技巧","path":"api/tags/技巧.json"},{"name":"开发工具","path":"api/tags/开发工具.json"}]}