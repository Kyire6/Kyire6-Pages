{"title":"使用 GitHub Actions 自动发布 Hexo 博客","slug":"GitHub-Actions自动发布Hexo博客","date":"2022-06-15T16:01:10.000Z","updated":"2022-06-15T16:01:10.000Z","comments":true,"path":"api/articles/GitHub-Actions自动发布Hexo博客.json","excerpt":null,"covers":["https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615223549.png","https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615231127.png","https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615231916.png","https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615233124.png","https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615232742.png","https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615232822.png","https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615235619.png"],"content":"<h2 id=\"GitHub-Actions-简介\"><a href=\"#GitHub-Actions-简介\" class=\"headerlink\" title=\"GitHub Actions 简介\"></a>GitHub Actions 简介</h2><p><code>GitHub Actions</code> 是一个持续集成和持续交付 (<code>CI/CD</code>) 平台，可用于自动执行构建、测试和部署管道。 您可以创建工作流程来构建和测试存储库的每个拉取请求，或将合并的拉取请求部署到生产环境。</p>\n<p><code>GitHub Actions</code> 不仅仅是 <code>DevOps</code>，还允许您在存储库中发生其他事件时运行工作流程。 例如，您可以运行工作流程，以便在有人在您的存储库中创建新问题时自动添加相应的标签。</p>\n<p><code>GitHub Actions</code> 有一些自己的术语。</p>\n<p>（1）<strong>workflow</strong> （工作流程）：持续集成一次运行的过程，就是一个 workflow。</p>\n<p>（2）<strong>job</strong> （任务）：一个 workflow 由一个或多个 jobs 构成，含义是一次持续集成的运行，可以完成多个任务。</p>\n<p>（3）<strong>step</strong>（步骤）：每个 job 由多个 step 构成，一步步完成。</p>\n<p>（4）<strong>action</strong> （动作）：每个 step 可以依次执行一个或多个命令（action）。</p>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><p>我的个人站点 <a href=\"https://blog.kyire.site/\">Kyire の Blog - 记录美好生活</a> 是通过 <a href=\"https://hexo.io/zh-cn/\">Hexo</a> 框架搭建的。</p>\n<blockquote>\n<p>搭建方法可参考：<a href=\"https://blog.kyire.site/2021/02/06/8fe2b6a8.html\">Hexo+Gitee 搭建个人博客 | Kyire の Blog</a></p>\n</blockquote>\n<p>准备三个仓库：</p>\n<ul>\n<li>私有<code>Hexo</code>源码仓库（<code>Blog</code>）：博客文章以及<code>Hexo</code>源代码</li>\n<li><code>GitHub</code>公共静态页面仓库（<code>Kyire6.github.io</code>）：<code>Hexo</code>源码编译后生成的静态页面</li>\n<li><code>Gitee</code>公共静态页面仓库（<code>Kyire6</code>）：内容跟 <code>Kyire6.github.io</code> 一样，只是使用的服务不同</li>\n</ul>\n<p>自动部署的流程如下：</p>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615223549.png\" alt=\"image-20220615223542331\"></p>\n<h2 id=\"GitHub-密钥配置\"><a href=\"#GitHub-密钥配置\" class=\"headerlink\" title=\"GitHub 密钥配置\"></a>GitHub 密钥配置</h2><p>生成 <code>ssh密钥对</code>，用于部署静态文件，以及更新 <code>Gitee Pages</code> 服务：</p>\n<ol>\n<li><strong>生成密钥</strong></li>\n</ol>\n<p>执行如下命令生成 <code>ssh密钥对</code>，替换邮件地址为你的<strong>GitHub 邮箱</strong>地址：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -f hexo-deploy-key -t rsa -C <span class=\"string\">&quot;username@example.com&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>命令执行后会生成两个文件：<code>hexo-deploy-key</code>（私钥） 和 <code>hexo-deploy-key.pub</code>（公钥）</p>\n<ol start=\"2\">\n<li><strong>将公钥添加到 Github Pages 仓库中</strong></li>\n</ol>\n<p><code>Kyire6.github.io仓库 -&gt; Settings -&gt; Deploy keys -&gt; Add deploy key</code></p>\n<ul>\n<li><code>Title</code> 设置为 <code>HEXO_DEPLOY_PUB</code></li>\n<li><code>Key</code> 填写 <code>hexo-deploy-key.pub</code> 文件内容</li>\n<li>勾选 <code>Allow write access</code> 选项</li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615231127.png\" alt=\"image-20220615231127446\"></p>\n<ol start=\"3\">\n<li><strong>将私钥添加到博客源码仓库中</strong></li>\n</ol>\n<p><code>Blog仓库 -&gt; Settings -&gt; Secrets -&gt; Actions -&gt; New repository secret</code></p>\n<ul>\n<li><code>Name</code> 填写 <code>HEXO_DEPLOY_KEY</code></li>\n<li><code>Value</code> 填写 <code>github-deploy-key</code> 文件内容</li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615231916.png\" alt=\"image-20220615231916597\"></p>\n<ol start=\"4\">\n<li><strong>将 Gitee 账号密码添加到博客源码仓库中</strong></li>\n</ol>\n<p><code>Blog仓库 -&gt; Settings -&gt; Secrets -&gt; Actions -&gt; New repository secret</code></p>\n<ul>\n<li><code>Name</code> 填写 <code>GITEE_PASSWORD</code></li>\n<li><code>Value</code> 填写 <code>Gitee账号的密码</code></li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615233124.png\" alt=\"image-20220615233124815\"></p>\n<h2 id=\"Gitee-密钥配置\"><a href=\"#Gitee-密钥配置\" class=\"headerlink\" title=\"Gitee 密钥配置\"></a>Gitee 密钥配置</h2><blockquote>\n<p>直接使用之前生成的密钥</p>\n</blockquote>\n<ol>\n<li><strong>将公钥添加到 Gitee Pages 仓库中</strong></li>\n</ol>\n<p><code>Kyire6仓库 -&gt; 管理 -&gt; 部署公钥管理 -&gt; 添加公钥</code></p>\n<p>和 <code>GitHub</code> 一样需要对仓库有写权限，点击<code>【添加个人公钥】</code></p>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615232742.png\" alt=\"image-20220615232742168\"></p>\n<ul>\n<li><code>标题</code> 设置为 <code>HEXO_DEPLOY_PUB</code></li>\n<li><code>公钥</code> 填写 <code>hexo-deploy-key.pub</code> 文件内容</li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615232822.png\" alt=\"image-20220615232822304\"></p>\n<h2 id=\"配置-GitHub-Actions\"><a href=\"#配置-GitHub-Actions\" class=\"headerlink\" title=\"配置 GitHub Actions\"></a>配置 GitHub Actions</h2><p>在博客源码仓库（Blog）中，编写 <code>workflow</code> 文件</p>\n<p>在仓库的根目录下创建 <code>.github/workflow/deploy.yml</code> 文件，yaml 文件名可以自定义。</p>\n<p>下面是结合 <a href=\"https://github.com/marketplace/actions/hexo-action#%F0%9F%8D%8Cexample-workflow---hexo-deploy\">Hexo Action</a>和<a href=\"https://github.com/marketplace/actions/gitee-pages-action\">Gitee Pages Action </a>的 <code>workflow</code> 文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Hexo</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">paths-ignore:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;source/_drafts/**&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;.github/**&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">build:</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">A</span> <span class=\"string\">job</span> <span class=\"string\">to</span> <span class=\"string\">deploy</span> <span class=\"string\">blog.</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Checkout</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v1</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"attr\">submodules:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Cache</span> <span class=\"string\">node</span> <span class=\"string\">modules</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">actions/cache@v1</span></span><br><span class=\"line\">      <span class=\"attr\">id:</span> <span class=\"string\">cache</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">node_modules</span></span><br><span class=\"line\">        <span class=\"attr\">key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">runner.os</span> <span class=\"string\">&#125;&#125;-node-$&#123;&#123;</span> <span class=\"string\">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">restore-keys:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          $&#123;&#123; runner.os &#125;&#125;-node-</span></span><br><span class=\"line\"><span class=\"string\"></span>    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Install</span> <span class=\"string\">Dependencies</span></span><br><span class=\"line\">      <span class=\"attr\">if:</span> <span class=\"string\">steps.cache.outputs.cache-hit</span> <span class=\"type\">!=</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">npm</span> <span class=\"string\">ci</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Deploy hexo blog website.</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Deploy</span></span><br><span class=\"line\">      <span class=\"attr\">id:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">sma11black/hexo-action@v1.0.4</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"comment\"># 用于访问 GitHub 静态页面仓库的部署密钥（私钥）。</span></span><br><span class=\"line\">        <span class=\"attr\">deploy_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.HEXO_DEPLOY_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"comment\"># 用于部署的 github 帐户的用户名。</span></span><br><span class=\"line\">        <span class=\"attr\">user_name:</span> <span class=\"string\">Kyire6</span></span><br><span class=\"line\">        <span class=\"comment\"># 用于部署的 github 帐户的用户电子邮件。</span></span><br><span class=\"line\">        <span class=\"attr\">user_email:</span> <span class=\"string\">kyire666@outlook.com</span></span><br><span class=\"line\">        <span class=\"attr\">commit_msg:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">github.event.head_commit.message</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Get</span> <span class=\"string\">the</span> <span class=\"string\">output</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        echo &quot;$&#123;&#123; steps.deploy.outputs.notify &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"attr\">sync:</span></span><br><span class=\"line\">    <span class=\"attr\">needs:</span> <span class=\"string\">build</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Sync</span> <span class=\"string\">to</span> <span class=\"string\">Gitee</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">wearerequired/git-mirror-action@master</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">          <span class=\"comment\"># 用于访问 GitHub 静态页面仓库的部署密钥（私钥）。</span></span><br><span class=\"line\">          <span class=\"attr\">SSH_PRIVATE_KEY:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.HEXO_DEPLOY_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"comment\"># 源仓库</span></span><br><span class=\"line\">          <span class=\"attr\">source-repo:</span> <span class=\"string\">git@github.com:Kyire6/Kyire6.github.io.git</span></span><br><span class=\"line\">          <span class=\"comment\"># 目标仓库</span></span><br><span class=\"line\">          <span class=\"attr\">destination-repo:</span> <span class=\"string\">git@gitee.com:Kyire6/Kyire6.git</span></span><br><span class=\"line\">  <span class=\"attr\">reload-pages:</span></span><br><span class=\"line\">    <span class=\"attr\">needs:</span> <span class=\"string\">sync</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Build</span> <span class=\"string\">Gitee</span> <span class=\"string\">Pages</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">yanglbme/gitee-pages-action@main</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"comment\"># Gitee登录用户名</span></span><br><span class=\"line\">          <span class=\"attr\">gitee-username:</span> <span class=\"string\">Kyire6</span></span><br><span class=\"line\">          <span class=\"comment\"># Gitee账号密码</span></span><br><span class=\"line\">          <span class=\"attr\">gitee-password:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_PASSWORD</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\"># Gitee仓库名称，注意大小写</span></span><br><span class=\"line\">          <span class=\"attr\">gitee-repo:</span> <span class=\"string\">Kyire6/Kyire6</span></span><br><span class=\"line\">          <span class=\"comment\"># 仓库分支名，根据实际情况填写</span></span><br><span class=\"line\">          <span class=\"attr\">branch:</span> <span class=\"string\">master</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>部分字段解释：</strong></p>\n<ol>\n<li><p><code>name</code>：workflow 名称</p>\n</li>\n<li><p><code>on</code>：触发 workflow 的事件</p>\n<ul>\n<li><code>push</code>：push 事件</li>\n<li><code>paths-ignore</code>：忽略指定的目录，也就是在忽略路径外的其它目录文件改动时才触发</li>\n<li>还可以设置多种触发条件，比如支持 cron 语法实现定时触发，参考<a href=\"https://docs.github.com/cn/actions/reference/events-that-trigger-workflows\">这里</a></li>\n</ul>\n</li>\n<li><p><code>jobs</code>：执行任务</p>\n<ul>\n<li><code>build</code>：博客编译和发布，发布到 Github Pages</li>\n<li><code>sync</code>：将更新后的 hiyongz.github.io 仓库同步到 Gitee</li>\n<li><code>reload-pages</code>：自动更新 Pages，因为 Gitee Pages 不像 GitHub Pages 那样提交代码就自动更新。</li>\n<li><code>runs-on</code>：运行环境，支持 windows，Ubuntu 和 macOS</li>\n<li><code>steps</code>：指定每个 Job 的运行步骤</li>\n<li><code>sma11black/hexo-action@v1.0.4</code>：博客构建发布，引用了 Hexo Action：</li>\n<li><code>wearerequired/git-mirror-action@master</code>：仓库同步，引用了 git-mirror-action</li>\n<li><code>yanglbme/gitee-pages-action@main</code>：自动更新 Gitee Pages，引用了 Gitee Pages Action</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p>参考资料：<a href=\"https://docs.github.com/cn/actions/using-workflows/workflow-syntax-for-github-actions\">GitHub Actions 的工作流程语法 - GitHub Docs</a></p>\n</blockquote>\n<h2 id=\"效果\"><a href=\"#效果\" class=\"headerlink\" title=\"效果\"></a>效果</h2><p>更新文章之后，提交博客源码到 <code>Blog</code> 仓库，满足 <code>GitHub Actions</code> 条件，触发 <code>deploy.yml</code> 中的编写的流水线：</p>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615235619.png\" alt=\"image-20220615235619570\"></p>\n<p>流水线运行成功，查看 <code>Kyire6.github.io</code> 和 Gitee 的 <code>Kyire6</code> 仓库可以发现都有更新（静态页面公共仓库），并且 <code>Gitee Pages</code> 服务也自动触发更新了，这样就通过 <code>GitHub Actions</code> 实现 <code>Hexo</code> 博客的自动发布。</p>\n<blockquote>\n<p><strong>以后只需要将文章写好之后，push 到博客源码仓库后，触发流水线自动编译并部署，实现 CI/CD 操作，提升效率，避免重复的人工操作！</strong></p>\n</blockquote>\n","more":"<h2 id=\"GitHub-Actions-简介\"><a href=\"#GitHub-Actions-简介\" class=\"headerlink\" title=\"GitHub Actions 简介\"></a>GitHub Actions 简介</h2><p><code>GitHub Actions</code> 是一个持续集成和持续交付 (<code>CI/CD</code>) 平台，可用于自动执行构建、测试和部署管道。 您可以创建工作流程来构建和测试存储库的每个拉取请求，或将合并的拉取请求部署到生产环境。</p>\n<p><code>GitHub Actions</code> 不仅仅是 <code>DevOps</code>，还允许您在存储库中发生其他事件时运行工作流程。 例如，您可以运行工作流程，以便在有人在您的存储库中创建新问题时自动添加相应的标签。</p>\n<p><code>GitHub Actions</code> 有一些自己的术语。</p>\n<p>（1）<strong>workflow</strong> （工作流程）：持续集成一次运行的过程，就是一个 workflow。</p>\n<p>（2）<strong>job</strong> （任务）：一个 workflow 由一个或多个 jobs 构成，含义是一次持续集成的运行，可以完成多个任务。</p>\n<p>（3）<strong>step</strong>（步骤）：每个 job 由多个 step 构成，一步步完成。</p>\n<p>（4）<strong>action</strong> （动作）：每个 step 可以依次执行一个或多个命令（action）。</p>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><p>我的个人站点 <a href=\"https://blog.kyire.site/\">Kyire の Blog - 记录美好生活</a> 是通过 <a href=\"https://hexo.io/zh-cn/\">Hexo</a> 框架搭建的。</p>\n<blockquote>\n<p>搭建方法可参考：<a href=\"https://blog.kyire.site/2021/02/06/8fe2b6a8.html\">Hexo+Gitee 搭建个人博客 | Kyire の Blog</a></p>\n</blockquote>\n<p>准备三个仓库：</p>\n<ul>\n<li>私有<code>Hexo</code>源码仓库（<code>Blog</code>）：博客文章以及<code>Hexo</code>源代码</li>\n<li><code>GitHub</code>公共静态页面仓库（<code>Kyire6.github.io</code>）：<code>Hexo</code>源码编译后生成的静态页面</li>\n<li><code>Gitee</code>公共静态页面仓库（<code>Kyire6</code>）：内容跟 <code>Kyire6.github.io</code> 一样，只是使用的服务不同</li>\n</ul>\n<p>自动部署的流程如下：</p>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615223549.png\" alt=\"image-20220615223542331\"></p>\n<h2 id=\"GitHub-密钥配置\"><a href=\"#GitHub-密钥配置\" class=\"headerlink\" title=\"GitHub 密钥配置\"></a>GitHub 密钥配置</h2><p>生成 <code>ssh密钥对</code>，用于部署静态文件，以及更新 <code>Gitee Pages</code> 服务：</p>\n<ol>\n<li><strong>生成密钥</strong></li>\n</ol>\n<p>执行如下命令生成 <code>ssh密钥对</code>，替换邮件地址为你的<strong>GitHub 邮箱</strong>地址：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -f hexo-deploy-key -t rsa -C <span class=\"string\">&quot;username@example.com&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>命令执行后会生成两个文件：<code>hexo-deploy-key</code>（私钥） 和 <code>hexo-deploy-key.pub</code>（公钥）</p>\n<ol start=\"2\">\n<li><strong>将公钥添加到 Github Pages 仓库中</strong></li>\n</ol>\n<p><code>Kyire6.github.io仓库 -&gt; Settings -&gt; Deploy keys -&gt; Add deploy key</code></p>\n<ul>\n<li><code>Title</code> 设置为 <code>HEXO_DEPLOY_PUB</code></li>\n<li><code>Key</code> 填写 <code>hexo-deploy-key.pub</code> 文件内容</li>\n<li>勾选 <code>Allow write access</code> 选项</li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615231127.png\" alt=\"image-20220615231127446\"></p>\n<ol start=\"3\">\n<li><strong>将私钥添加到博客源码仓库中</strong></li>\n</ol>\n<p><code>Blog仓库 -&gt; Settings -&gt; Secrets -&gt; Actions -&gt; New repository secret</code></p>\n<ul>\n<li><code>Name</code> 填写 <code>HEXO_DEPLOY_KEY</code></li>\n<li><code>Value</code> 填写 <code>github-deploy-key</code> 文件内容</li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615231916.png\" alt=\"image-20220615231916597\"></p>\n<ol start=\"4\">\n<li><strong>将 Gitee 账号密码添加到博客源码仓库中</strong></li>\n</ol>\n<p><code>Blog仓库 -&gt; Settings -&gt; Secrets -&gt; Actions -&gt; New repository secret</code></p>\n<ul>\n<li><code>Name</code> 填写 <code>GITEE_PASSWORD</code></li>\n<li><code>Value</code> 填写 <code>Gitee账号的密码</code></li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615233124.png\" alt=\"image-20220615233124815\"></p>\n<h2 id=\"Gitee-密钥配置\"><a href=\"#Gitee-密钥配置\" class=\"headerlink\" title=\"Gitee 密钥配置\"></a>Gitee 密钥配置</h2><blockquote>\n<p>直接使用之前生成的密钥</p>\n</blockquote>\n<ol>\n<li><strong>将公钥添加到 Gitee Pages 仓库中</strong></li>\n</ol>\n<p><code>Kyire6仓库 -&gt; 管理 -&gt; 部署公钥管理 -&gt; 添加公钥</code></p>\n<p>和 <code>GitHub</code> 一样需要对仓库有写权限，点击<code>【添加个人公钥】</code></p>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615232742.png\" alt=\"image-20220615232742168\"></p>\n<ul>\n<li><code>标题</code> 设置为 <code>HEXO_DEPLOY_PUB</code></li>\n<li><code>公钥</code> 填写 <code>hexo-deploy-key.pub</code> 文件内容</li>\n</ul>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615232822.png\" alt=\"image-20220615232822304\"></p>\n<h2 id=\"配置-GitHub-Actions\"><a href=\"#配置-GitHub-Actions\" class=\"headerlink\" title=\"配置 GitHub Actions\"></a>配置 GitHub Actions</h2><p>在博客源码仓库（Blog）中，编写 <code>workflow</code> 文件</p>\n<p>在仓库的根目录下创建 <code>.github/workflow/deploy.yml</code> 文件，yaml 文件名可以自定义。</p>\n<p>下面是结合 <a href=\"https://github.com/marketplace/actions/hexo-action#%F0%9F%8D%8Cexample-workflow---hexo-deploy\">Hexo Action</a>和<a href=\"https://github.com/marketplace/actions/gitee-pages-action\">Gitee Pages Action </a>的 <code>workflow</code> 文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">Hexo</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">paths-ignore:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;source/_drafts/**&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;.github/**&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">build:</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">A</span> <span class=\"string\">job</span> <span class=\"string\">to</span> <span class=\"string\">deploy</span> <span class=\"string\">blog.</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Checkout</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v1</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"attr\">submodules:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Cache</span> <span class=\"string\">node</span> <span class=\"string\">modules</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">actions/cache@v1</span></span><br><span class=\"line\">      <span class=\"attr\">id:</span> <span class=\"string\">cache</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">node_modules</span></span><br><span class=\"line\">        <span class=\"attr\">key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">runner.os</span> <span class=\"string\">&#125;&#125;-node-$&#123;&#123;</span> <span class=\"string\">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">restore-keys:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">          $&#123;&#123; runner.os &#125;&#125;-node-</span></span><br><span class=\"line\"><span class=\"string\"></span>    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Install</span> <span class=\"string\">Dependencies</span></span><br><span class=\"line\">      <span class=\"attr\">if:</span> <span class=\"string\">steps.cache.outputs.cache-hit</span> <span class=\"type\">!=</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">npm</span> <span class=\"string\">ci</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Deploy hexo blog website.</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Deploy</span></span><br><span class=\"line\">      <span class=\"attr\">id:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\">      <span class=\"attr\">uses:</span> <span class=\"string\">sma11black/hexo-action@v1.0.4</span></span><br><span class=\"line\">      <span class=\"attr\">with:</span></span><br><span class=\"line\">        <span class=\"comment\"># 用于访问 GitHub 静态页面仓库的部署密钥（私钥）。</span></span><br><span class=\"line\">        <span class=\"attr\">deploy_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.HEXO_DEPLOY_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"comment\"># 用于部署的 github 帐户的用户名。</span></span><br><span class=\"line\">        <span class=\"attr\">user_name:</span> <span class=\"string\">Kyire6</span></span><br><span class=\"line\">        <span class=\"comment\"># 用于部署的 github 帐户的用户电子邮件。</span></span><br><span class=\"line\">        <span class=\"attr\">user_email:</span> <span class=\"string\">kyire666@outlook.com</span></span><br><span class=\"line\">        <span class=\"attr\">commit_msg:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">github.event.head_commit.message</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Get</span> <span class=\"string\">the</span> <span class=\"string\">output</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        echo &quot;$&#123;&#123; steps.deploy.outputs.notify &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"attr\">sync:</span></span><br><span class=\"line\">    <span class=\"attr\">needs:</span> <span class=\"string\">build</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Sync</span> <span class=\"string\">to</span> <span class=\"string\">Gitee</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">wearerequired/git-mirror-action@master</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">          <span class=\"comment\"># 用于访问 GitHub 静态页面仓库的部署密钥（私钥）。</span></span><br><span class=\"line\">          <span class=\"attr\">SSH_PRIVATE_KEY:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.HEXO_DEPLOY_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"comment\"># 源仓库</span></span><br><span class=\"line\">          <span class=\"attr\">source-repo:</span> <span class=\"string\">git@github.com:Kyire6/Kyire6.github.io.git</span></span><br><span class=\"line\">          <span class=\"comment\"># 目标仓库</span></span><br><span class=\"line\">          <span class=\"attr\">destination-repo:</span> <span class=\"string\">git@gitee.com:Kyire6/Kyire6.git</span></span><br><span class=\"line\">  <span class=\"attr\">reload-pages:</span></span><br><span class=\"line\">    <span class=\"attr\">needs:</span> <span class=\"string\">sync</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Build</span> <span class=\"string\">Gitee</span> <span class=\"string\">Pages</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">yanglbme/gitee-pages-action@main</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"comment\"># Gitee登录用户名</span></span><br><span class=\"line\">          <span class=\"attr\">gitee-username:</span> <span class=\"string\">Kyire6</span></span><br><span class=\"line\">          <span class=\"comment\"># Gitee账号密码</span></span><br><span class=\"line\">          <span class=\"attr\">gitee-password:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_PASSWORD</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\"># Gitee仓库名称，注意大小写</span></span><br><span class=\"line\">          <span class=\"attr\">gitee-repo:</span> <span class=\"string\">Kyire6/Kyire6</span></span><br><span class=\"line\">          <span class=\"comment\"># 仓库分支名，根据实际情况填写</span></span><br><span class=\"line\">          <span class=\"attr\">branch:</span> <span class=\"string\">master</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>部分字段解释：</strong></p>\n<ol>\n<li><p><code>name</code>：workflow 名称</p>\n</li>\n<li><p><code>on</code>：触发 workflow 的事件</p>\n<ul>\n<li><code>push</code>：push 事件</li>\n<li><code>paths-ignore</code>：忽略指定的目录，也就是在忽略路径外的其它目录文件改动时才触发</li>\n<li>还可以设置多种触发条件，比如支持 cron 语法实现定时触发，参考<a href=\"https://docs.github.com/cn/actions/reference/events-that-trigger-workflows\">这里</a></li>\n</ul>\n</li>\n<li><p><code>jobs</code>：执行任务</p>\n<ul>\n<li><code>build</code>：博客编译和发布，发布到 Github Pages</li>\n<li><code>sync</code>：将更新后的 hiyongz.github.io 仓库同步到 Gitee</li>\n<li><code>reload-pages</code>：自动更新 Pages，因为 Gitee Pages 不像 GitHub Pages 那样提交代码就自动更新。</li>\n<li><code>runs-on</code>：运行环境，支持 windows，Ubuntu 和 macOS</li>\n<li><code>steps</code>：指定每个 Job 的运行步骤</li>\n<li><code>sma11black/hexo-action@v1.0.4</code>：博客构建发布，引用了 Hexo Action：</li>\n<li><code>wearerequired/git-mirror-action@master</code>：仓库同步，引用了 git-mirror-action</li>\n<li><code>yanglbme/gitee-pages-action@main</code>：自动更新 Gitee Pages，引用了 Gitee Pages Action</li>\n</ul>\n</li>\n</ol>\n<blockquote>\n<p>参考资料：<a href=\"https://docs.github.com/cn/actions/using-workflows/workflow-syntax-for-github-actions\">GitHub Actions 的工作流程语法 - GitHub Docs</a></p>\n</blockquote>\n<h2 id=\"效果\"><a href=\"#效果\" class=\"headerlink\" title=\"效果\"></a>效果</h2><p>更新文章之后，提交博客源码到 <code>Blog</code> 仓库，满足 <code>GitHub Actions</code> 条件，触发 <code>deploy.yml</code> 中的编写的流水线：</p>\n<p><img src=\"https://my-typora-oss.oss-cn-shanghai.aliyuncs.com/image-master/20220615235619.png\" alt=\"image-20220615235619570\"></p>\n<p>流水线运行成功，查看 <code>Kyire6.github.io</code> 和 Gitee 的 <code>Kyire6</code> 仓库可以发现都有更新（静态页面公共仓库），并且 <code>Gitee Pages</code> 服务也自动触发更新了，这样就通过 <code>GitHub Actions</code> 实现 <code>Hexo</code> 博客的自动发布。</p>\n<blockquote>\n<p><strong>以后只需要将文章写好之后，push 到博客源码仓库后，触发流水线自动编译并部署，实现 CI/CD 操作，提升效率，避免重复的人工操作！</strong></p>\n</blockquote>\n","categories":[{"name":"随笔小记","path":"api/categories/随笔小记.json"}],"tags":[{"name":"笔记","path":"api/tags/笔记.json"},{"name":"Git","path":"api/tags/Git.json"},{"name":"Hexo","path":"api/tags/Hexo.json"},{"name":"GitHub","path":"api/tags/GitHub.json"}]}